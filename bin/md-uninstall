#!/bin/bash

export setCmd="set -eo pipefail"
$setCmd

export PATH=/opt/MonkeyDev/bin:/usr/local/bin:/usr/bin:/usr/sbin:/bin:/sbin:$PATH

export scriptName="${0##*/}"
export scriptVer="2.0"

export MonkeyDevPath="/opt/MonkeyDev"
export backupFileExt=".MonkeyDev"

export userName="${SUDO_USER-$USER}"
export userGroup=`id -g $userName`
export userHome=`eval echo ~$userName`
export bashProfileFiles=("$userHome/.zshrc" "$userHome/.bash_profile" "$userHome/.bashrc" "$userHome/.bash_login" "$userHome/.profile")

export tempDirsFile="`mktemp -d -t $scriptName`/tempdirs"
touch "$tempDirsFile"

unset LANG

function cleanup()
{
	local exitCode=$?
	set +e
	trap - $signals
	removeTempData
	exit $exitCode
}
function panic()
{
	local exitCode=$1
	set +e
	shift
	[[ "$@" == "" ]] || echo "$@" >&2
	exit $exitCode
}
export signals="0 1 2 3 15"
trap cleanup $signals

function removeTempData()
{
	local tempDirs
	if [[ -f "$tempDirsFile" ]]; then
		tempDirs=(`cat "$tempDirsFile"`)
		for td in "${tempDirs[@]}"; do
			rm -rf "$td" || true
		done
		rm -rf "`dirname $tempDirsFile`" || true
	fi
}

echo "Uninstalling MonkeyDev base, Xcode templates and framework header files..."
	
#删除文件夹
rm -rf "$MonkeyDevPath" || \
	panic $? "Failed to remove directory: $MonkeyDevPath"

#移除模块符号链接
userDevDir="$userHome/Library/Developer"
userTemplatesDir="$userDevDir/Xcode/Templates"
symlinkPath="$userTemplatesDir/MonkeyDev"

rm -f "$symlinkPath" || \
	panic $? "Failed to remove file: $symlinkPath"
		
#移除profile环境变量
for f in "${bashProfileFiles[@]}"; do
	if [[ -f "$f" ]]; then
		userBashProfileFile="$f"
		break
	fi
done
	
if [[ $userBashProfileFile != "" ]]; then
	sed -i "" "s/^export MonkeyDevPath=.*$//g" "$userBashProfileFile"
	sed -i "" "s/^export MonkeyDevDevice=.*$//g" "$userBashProfileFile"
	sed -i "" "s/^export PATH=.*${MonkeyDevPath//\//\\/}\\/bin:.*$//g" "$userBashProfileFile"
	sed -i "" "s/^export PATH=.*\$MonkeyDevPath\\/bin:.*$//g" "$userBashProfileFile"
fi

exit 0